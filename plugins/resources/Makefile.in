
include ../../iRODS/config/platform.mk
include ../../iRODS/config/config.mk

GCC = g++ -DRODS_SERVER -DZIP_EXEC_PATH=\"$(ZIP_EXEC_PATH)\" -DUNZIP_EXEC_PATH=\"$(UNZIP_EXEC_PATH)\"
GCC += `../../packaging/compiler_check.sh 4 2`

ifeq ($(IRODS_BUILD_COVERAGE), 1)
GCC += -fprofile-arcs -ftest-coverage -lgcov
endif

DEPS = base

ifeq ($(IRODS_BUILD_DEBUG), 0)
DEPS += hpss
endif

.PHONY = base hpss

INC = -I ../../iRODS/lib/core/include/ -I ../../iRODS/lib/api/include/ -I../../iRODS/lib/md5/include \
      -I../../iRODS/server/core/include/ -I../../iRODS/server/icat/include/ -I../../iRODS/server/re/include/ \
      -I../../iRODS/server/drivers/include/ -I$(LIBARCHIVE_DIR)/libarchive/ -I$(BOOST_DIR) \
      -I/opt/hpss/include  -L/opt/hpss/lib

default: ${DEPS}

hpss:
	${GCC} ${INC} -DHPSS -Dlinux_platform -lcurl -fPIC -shared -o libhpss.so            libhpss.cpp      /opt/hpss/lib/libhpss.so /opt/hpss/lib/libhpsscs.so

wos:
	${GCC} ${INC} -DUSING_JSON -Dlinux_platform -fPIC -shared -o libwos.so libwos.cpp
	${GCC} ${INC} -Dlinux_platform -fPIC -shared -o libwoscoordinator.so libwoscoordinator.cpp

base:
	${GCC} ${INC} -Dlinux_platform -fPIC -shared -o libroundrobin.so      libroundrobin.cpp 
	${GCC} ${INC} -Dlinux_platform -fPIC -shared -o libunixfilesystem.so  libunixfilesystem.cpp 
	${GCC} ${INC} -Dlinux_platform -fPIC -shared -o libpassthru.so        libpassthru.cpp 
	${GCC} ${INC} -Dlinux_platform -fPIC -shared -o librepl.so            librepl.cpp irods_replicator.cpp irods_create_write_replicator.cpp irods_unlink_replicator.cpp irods_object_oper.cpp
	${GCC} ${INC} -Dlinux_platform -fPIC -shared -o libnonblocking.so     libnonblocking.cpp 
	${GCC} ${INC} -Dlinux_platform -fPIC -shared -o libstructfile.so      libstructfile.cpp \
	$(LIBARCHIVE_DIR)/libarchive/libarchive.a \
	$(BOOST_DIR)/stage/lib/libboost_filesystem.a \
	$(BOOST_DIR)/stage/lib/libboost_system.a \
	SYSTEM_LIBZ_SO \
	SYSTEM_LIBBZ2_SO
